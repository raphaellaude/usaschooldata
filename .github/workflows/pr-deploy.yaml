name: Fly Deploy Pull Request App
on:
  pull_request:
    types: [opened, reopened, synchronize, closed]
    paths:
      - "app/**"
      - ".github/workflows/pr-deploy.yaml"

env:
  FLY_API_TOKEN: ${{ secrets.FLY_ORG_TOKEN }}
  FLY_REGION: "iad"

jobs:
  pr_review_app:
    runs-on: ubuntu-latest

    permissions:
      pull-requests: write
      contents: read

    concurrency:
      group: pr-${{ github.event.number }}

    environment:
      name: pr-${{ github.event.number }}
      url: https://${{ github.event.repository.name }}-pr-${{ github.event.number }}.fly.dev

    steps:
      - uses: actions/checkout@v3
      - uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Set app name
        run: |
          echo "app_name=${{ github.event.repository.name }}-pr-${{ github.event.number }}" >> $GITHUB_ENV

      - name: Destroy app
        if: github.event.action == 'closed'
        run: |
          app_name="${{ env.app_name }}"
          echo "Destroying app $app_name"
          flyctl apps destroy "$app_name" -y || echo "App $app_name does not exist or already destroyed"
          echo "Resources for PR #${{ github.event.number }} have been destroyed."

      - name: Create app
        if: github.event.action != 'closed'
        run: |
          app="${{ env.app_name }}"

          # Check if the app exists
          if flyctl apps list | grep -q "$app"; then
            echo "App $app already exists. Skipping creation."
          else
            echo "Creating app $app"
            flyctl apps create "$app" --org personal --machines
            echo "App $app created successfully."
          fi
        working-directory: app

      - name: Deploy app
        if: github.event.action != 'closed'
        run: |
          flyctl deploy \
            --remote-only \
            --config fly.toml \
            --app "${{ env.app_name }}" \
            --region ${{ env.FLY_REGION }} \
            --strategy immediate \
            --ha=false \
            --vm-cpu-kind shared \
            --vm-cpus 1 \
            --vm-memory 512
        working-directory: app

      - name: Comment PR with app URL
        if: github.event.action != 'closed'
        uses: actions/github-script@v7
        with:
          script: |
            const appUrl = 'https://${{ env.app_name }}.fly.dev';
            const comment = `## Preview Deployment Ready

            Your preview app has been deployed to Fly.io:

            **URL:** ${appUrl}

            This deployment will be automatically destroyed when the PR is closed.`;

            // Check if we already commented
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Preview Deployment Ready')
            );

            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
